{% extends 'prograos/base.html' %}
{% load static %}
{% load humanize %}

{% block title %}Dashboard{% endblock %}

{% block content %}
<div id="dashboard-page">
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="h2">Dashboard</h1>
    </div>

    {# ===================== KPIs ===================== #}
    <div class="row g-3">
        <div class="col-md-4">
            <div class="card border-0 shadow-sm" style="background: linear-gradient(135deg, #0d6efd, #6610f2); color:#fff;">
                <div class="card-body d-flex justify-content-between align-items-center">
                    <div>
                        <div class="small text-white-50">Receita (30 dias)</div>
                        <div class="fs-3 fw-bold"><span id="kpi-receita">R$ 0,00</span></div>
                    </div>
                    <i class="fas fa-arrow-trend-up fa-2x opacity-75"></i>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-0 shadow-sm" style="background: linear-gradient(135deg, #20c997, #0d6efd); color:#fff;">
                <div class="card-body d-flex justify-content-between align-items-center">
                    <div>
                        <div class="small text-white-50">Custo (30 dias)</div>
                        <div class="fs-3 fw-bold"><span id="kpi-custo">R$ 0,00</span></div>
                    </div>
                    <i class="fas fa-sack-dollar fa-2x opacity-75"></i>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-0 shadow-sm" style="background: linear-gradient(135deg, #198754, #0f5132); color:#fff;">
                <div class="card-body d-flex justify-content-between align-items-center">
                    <div>
                        <div class="small text-white-50">Lucro (30 dias)</div>
                        <div class="fs-3 fw-bold"><span id="kpi-lucro">R$ 0,00</span></div>
                    </div>
                    <i class="fas fa-coins fa-2x opacity-75"></i>
                </div>
            </div>
        </div>
    </div>

    {# ===================== GRÁFICOS ===================== #}
    <div class="row g-3 mt-1">
        <div class="col-12 col-lg-8">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white">
                    <h5 class="mb-0">Lucro Mensal</h5>
                </div>
                <div class="card-body">
                    <canvas id="chart-lucro-mensal" height="120"></canvas>
                </div>
            </div>
        </div>
        <div class="col-12 col-lg-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-white">
                    <h5 class="mb-0">Status dos Pagamentos</h5>
                </div>
                <div class="card-body">
                    <canvas id="chart-status" height="220"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-3 mt-1">
        <div class="col-12 col-lg-8">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white">
                    <h5 class="mb-0">Receita vs. Custo (Mensal)</h5>
                </div>
                <div class="card-body">
                    <canvas id="chart-receita-custo" height="120"></canvas>
                </div>
            </div>
        </div>
        <div class="col-12 col-lg-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-white">
                    <h5 class="mb-0">Mix de Grãos</h5>
                </div>
                <div class="card-body">
                    <canvas id="chart-mix" height="220"></canvas>
                </div>
            </div>
        </div>
    </div>

    {# ===================== SUAS TABELAS (inalteradas) ===================== #}

    <!-- Resumo de pagamentos -->
    <div class="card mt-4">
        <div class="card-header">
            <h5 class="mb-0">Resumo Financeiro das Últimas Operações</h5>
        </div>
        <div class="card-body p-0">
            {% if ultimos_registros_financeiros %}
            <div class="table-responsive">
                <table class="table table-striped table-hover mb-0">
                    <thead>
                        <tr>
                            <th>Nota Nº</th>
                            <th>Placa</th>
                            <th>Valor Total</th>
                            <th>Valor Pago</th>
                            <th class="text-danger">Valor Restante</th>
                            <th>Custo</th>
                            <th>Lucro</th>
                            <th>Status Pag.</th>
                            <th class="text-center">Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for registro in ultimos_registros_financeiros %}
                        <tr>
                            <td>#{{ registro.nota.id }}</td>
                            <td>{{ registro.nota.pesagem.placa|default:"N/A" }}</td>
                            <td>R$ {{ registro.nota.valor_total|floatformat:2 }}</td>
                            <td>R$ {{ registro.valor_pago|floatformat:2 }}</td>
                            <td>
                                <strong class="text-danger">
                                    R$ {{ registro.calcular_valor_restante|floatformat:2 }}
                                </strong>
                            </td>
                            <td>R$ {{ registro.valor_custo_total|default:"0.00"|floatformat:2 }}</td>
                            <td>
                                <strong class="{% if registro.lucro > 0 %}text-success{% elif registro.lucro < 0 %}text-danger{% endif %}">
                                    R$ {{ registro.lucro|default:"0.00"|floatformat:2 }}
                                </strong>
                            </td>
                            <td>
                                {% if registro.status_pagamento == 'PAGO' %}
                                    <span class="badge bg-success">{{ registro.get_status_pagamento_display }}</span>
                                {% elif registro.status_pagamento == 'PARCIAL' %}
                                    <span class="badge bg-warning text-dark">{{ registro.get_status_pagamento_display }}</span>
                                {% else %}
                                    <span class="badge bg-danger">{{ registro.get_status_pagamento_display }}</span>
                                {% endif %}
                            </td>
                            <td class="text-center">
                                <a href="{% url 'prograos:financeiro_detail' nota_pk=registro.nota.pk %}" class="btn btn-sm btn-info" title="Ver Detalhes Financeiros">
                                    <i class="fas fa-eye"></i>
                                </a>
                                <a href="{% url 'prograos:pagamento_create' nota_pk=registro.nota.pk %}" class="btn btn-sm btn-success" title="Adicionar Pagamento">
                                    <i class="fas fa-plus"></i> <i class="fas fa-dollar-sign"></i>
                                </a>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="7" class="text-center py-4">Nenhuma operação financeira encontrada.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="card-body text-center">
                <p class="mb-0">Nenhuma operação financeira encontrada.</p>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Tabela Últimas Pesagens de Caminhões -->
    <div class="card mt-4">
        <div class="card-header">
            <h5 class="mb-0">Últimas Pesagens de Caminhões</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>Placa</th>
                            <th>Tipo Grão</th>
                            <th>Peso Líquido (kg)</th>
                            <th>Sacos (un)</th>
                            <th>Data</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for pesagem in ultimas_pesagens %}
                        <tr>
                            <td>{{ pesagem.placa }}</td>
                            <td>{{ pesagem.tipo_grao }}</td>
                            <td>{{ pesagem.peso_liquido|floatformat:2 }}</td>
                            <td>{{ pesagem.quantidade_sacos|floatformat:0 }}</td>
                            <td>{{ pesagem.data_final|date:"d/m/Y H:i" }}</td>
                            <td>
                                <a href="{% url 'prograos:pesagem_detail' pesagem.id %}" class="btn btn-info btn-sm" title="Ver Detalhes">
                                    <i class="fas fa-eye"></i>
                                </a>
                                <a href="{% url 'prograos:pesagem_update' pesagem.id %}" class="btn btn-warning btn-sm" title="Editar">
                                    <i class="fas fa-edit"></i>
                                </a>
                                <a href="{% url 'prograos:pesagem_delete' pesagem.id %}" class="btn btn-danger btn-sm btn-delete" title="Excluir">
                                    <i class="fas fa-trash"></i>
                                </a>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="7" class="text-center">Nenhuma pesagem de caminhão encontrada.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Tabela Últimas Notas de Carregamento -->
    <div class="card mt-4 mb-4">
        <div class="card-header">
            <h5 class="mb-0">Últimas Notas de Carregamento</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>Placa</th>
                            <th>Recebedor</th>
                            <th>Tipo Grão</th>
                            <th>Total Sacos</th>
                            <th>Valor Total</th>
                            <th>Data</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for nota in ultimas_notas %}
                        <tr>
                            <td>{{ nota.pesagem.placa }}</td>
                            <td>{{ nota.nome_recebedor }}</td>
                            <td>{{ nota.tipo_grao }}</td>
                            <td>{{ nota.pesagem.quantidade_sacos|floatformat:0 }}</td>
                            <td>R$ {{ nota.valor_total|floatformat:2 }}</td>
                            <td>{{ nota.data_criacao|date:"d/m/Y H:i" }}</td>
                            <td>
                                <a href="{% url 'prograos:nota_detail' nota.id %}" class="btn btn-info btn-sm" title="Ver Detalhes">
                                    <i class="fas fa-eye"></i>
                                </a>
                                <a href="{% url 'prograos:nota_update' nota.id %}" class="btn btn-warning btn-sm" title="Editar">
                                    <i class="fas fa-edit"></i>
                                </a>
                                <a href="{% url 'prograos:nota_delete' nota.id %}" class="btn btn-danger btn-sm btn-delete">
                                    <i class="fas fa-trash"></i>
                                </a>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="7" class="text-center">Nenhuma nota de carregamento encontrada.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

</div>
{% endblock %}

{% block extra_js %}
{# ======== BLOBs JSON vindos da view (sem usar json_script) ======== #}
<script type="application/json" id="monthly-labels">{{ monthly_labels_json|safe }}</script>
<script type="application/json" id="monthly-receita">{{ monthly_receita_json|safe }}</script>
<script type="application/json" id="monthly-custo">{{ monthly_custo_json|safe }}</script>
<script type="application/json" id="monthly-lucro">{{ monthly_lucro_json|safe }}</script>
<script type="application/json" id="status-pagamentos">{{ status_pagamentos_json|safe }}</script>
<script type="application/json" id="mix-graos">{{ mix_graos_json|safe }}</script>
<script type="application/json" id="kpis">{{ kpis_json|safe }}</script>

{# ======== Chart.js ======== #}
<script defer src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<script>
(function () {
  const fmtBRL = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' });

  function parseJSON(id, fallback) {
    const el = document.getElementById(id);
    if (!el) return fallback;
    try { return JSON.parse(el.textContent || ''); } catch { return fallback; }
  }

  const monthlyLabels  = parseJSON('monthly-labels', []);
  const monthlyReceita = parseJSON('monthly-receita', []);
  const monthlyCusto   = parseJSON('monthly-custo', []);
  const monthlyLucro   = parseJSON('monthly-lucro', []);
  const statusCounts   = parseJSON('status-pagamentos', {PAGO:0, PARCIAL:0, PENDENTE:0});
  const mixGraosCounts = parseJSON('mix-graos', {SOJA:0, MILHO:0});
  const KPIS           = parseJSON('kpis', {receita_30:0, custo_30:0, lucro_30:0});

  function ready(fn){ document.readyState!=='loading'?fn():document.addEventListener('DOMContentLoaded',fn); }

  ready(function() {
    // KPIs
    const kpiR = document.getElementById('kpi-receita');
    const kpiC = document.getElementById('kpi-custo');
    const kpiL = document.getElementById('kpi-lucro');
    if (kpiR) kpiR.textContent = fmtBRL.format(KPIS.receita_30 || 0);
    if (kpiC) kpiC.textContent = fmtBRL.format(KPIS.custo_30   || 0);
    if (kpiL) kpiL.textContent = fmtBRL.format(KPIS.lucro_30   || 0);

    if (typeof window.Chart === 'undefined') return;

    // Lucro Mensal
    (function() {
      const el = document.getElementById('chart-lucro-mensal');
      if (!el) return;
      new Chart(el, {
        type: 'line',
        data: { labels: monthlyLabels, datasets: [{ label:'Lucro', data: monthlyLucro, fill:true, tension:0.35 }] },
        options: {
          responsive: true,
          plugins: {
            legend: { display: true },
            tooltip: { callbacks: { label: (ctx)=>` ${fmtBRL.format(ctx.parsed.y||0)}` } }
          },
          scales: { y: { ticks: { callback: (v)=>fmtBRL.format(v) } } }
        }
      });
    })();

    // Receita vs Custo
    (function() {
      const el = document.getElementById('chart-receita-custo');
      if (!el) return;
      new Chart(el, {
        type: 'bar',
        data: {
          labels: monthlyLabels,
          datasets: [
            { label:'Receita', data: monthlyReceita, stack:'totais' },
            { label:'Custo',   data: monthlyCusto,   stack:'totais' }
          ]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: true },
            tooltip: { callbacks: { label: (ctx)=>` ${ctx.dataset.label}: ${fmtBRL.format(ctx.parsed.y||0)}` } }
          },
          scales: {
            x: { stacked: true },
            y: { stacked: true, ticks: { callback: (v)=>fmtBRL.format(v) } }
          }
        }
      });
    })();

    // Status Pagamentos
    (function() {
      const el = document.getElementById('chart-status');
      if (!el) return;
      const data = [
        Number(statusCounts.PAGO||0),
        Number(statusCounts.PARCIAL||0),
        Number(statusCounts.PENDENTE||0)
      ];
      new Chart(el, {
        type: 'doughnut',
        data: { labels: ['Pago','Parcial','Pendente'], datasets: [{ data }] },
        options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
      });
    })();

    // Mix de Grãos
    (function() {
      const el = document.getElementById('chart-mix');
      if (!el) return;
      const data = [Number(mixGraosCounts.SOJA||0), Number(mixGraosCounts.MILHO||0)];
      new Chart(el, {
        type: 'pie',
        data: { labels: ['Soja','Milho'], datasets: [{ data }] },
        options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
      });
    })();

    // Se você tiver um filterTable() próprio, mantém:
    if (typeof filterTable === 'function') {
      try { filterTable(); } catch (e) { console.warn('filterTable falhou:', e); }
    }
  });
})();
</script>
{% endblock %}
