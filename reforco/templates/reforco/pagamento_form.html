{% extends 'reforco/base.html' %}
{% load static %}

{% block title %}{{ title }} - Sistema de Gestão de Alunos{% endblock %}

{% block header_title %}{{ title }}{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h5 class="mb-0">
            <i class="fas fa-money-bill-wave me-2"></i>
            {{ title }}
        </h5>
    </div>
    <div class="card-body">
        <form method="post">
            {% csrf_token %}

            <div class="row mb-3">
                <div class="col-md-6">
                    <label for="{{ form.aluno.id_for_label }}" class="form-label">Aluno</label>
                    {{ form.aluno }}
                    {% if form.aluno.errors %}
                    <div class="invalid-feedback d-block">
                        {{ form.aluno.errors }}
                    </div>
                    {% endif %}
                </div>
                <div class="col-md-6">
                    <label for="{{ form.mes_referencia.id_for_label }}" class="form-label">Mês de Referência</label>
                    {{ form.mes_referencia }}
                    {% if form.mes_referencia.errors %}
                    <div class="invalid-feedback d-block">
                        {{ form.mes_referencia.errors }}
                    </div>
                    {% endif %}
                </div>
            </div>

            <div class="row mb-3">
                <div class="col-md-6">
                    <label for="{{ form.valor.id_for_label }}" class="form-label">Valor</label>
                    {{ form.valor }}
                    {% if form.valor.errors %}
                    <div class="invalid-feedback d-block">
                        {{ form.valor.errors }}
                    </div>
                    {% endif %}
                </div>
                <div class="col-md-6">
                    <div class="form-check mt-4">
                        {{ form.pago }}
                        <label class="form-check-label" for="{{ form.pago.id_for_label }}">
                            Pagamento Realizado
                        </label>
                        {% if form.pago.errors %}
                        <div class="invalid-feedback d-block">
                            {{ form.pago.errors }}
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="row mb-3">
                <div class="col-md-6">
                    <label for="{{ form.data_pagamento.id_for_label }}" class="form-label">Data do Pagamento</label>
                    {{ form.data_pagamento }}
                    {% if form.data_pagamento.errors %}
                    <div class="invalid-feedback d-block">
                        {{ form.data_pagamento.errors }}
                    </div>
                    {% endif %}
                    <small class="form-text text-muted">Preencha apenas se o pagamento foi realizado.</small>
                </div>
            </div>

            <div class="mb-3">
                <label for="{{ form.observacao.id_for_label }}" class="form-label">Observação</label>
                {{ form.observacao }}
                {% if form.observacao.errors %}
                <div class="invalid-feedback d-block">
                    {{ form.observacao.errors }}
                </div>
                {% endif %}
            </div>

            <div class="d-flex justify-content-between">
                <a href="{% url 'pagamento_list' %}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left me-2"></i>
                    Voltar
                </a>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save me-2"></i>
                    Salvar
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Initialize datepicker for reference month
        if (typeof flatpickr !== 'undefined') {
            flatpickr("#{{ form.mes_referencia.id_for_label }}", {
                dateFormat: "d/m/Y",
                locale: "pt"
            });

            flatpickr("#{{ form.data_pagamento.id_for_label }}", {
                dateFormat: "d/m/Y",
                locale: "pt"
            });
        }

        // Mostrar/esconder data de pagamento baseado no checkbox de pago
        const pagoCheckbox = document.getElementById('{{ form.pago.id_for_label }}');
        const dataPagamentoField = document.getElementById('{{ form.data_pagamento.id_for_label }}');
        const dataPagamentoContainer = dataPagamentoField.closest('.col-md-6');

        function toggleDataPagamento() {
            if (pagoCheckbox.checked) {
                dataPagamentoContainer.style.display = 'block';
                // If no date is filled, fill with current date
                if (!dataPagamentoField.value) {
                    const today = new Date();
                    const day = String(today.getDate()).padStart(2, '0');
                    const month = String(today.getMonth() + 1).padStart(2, '0');
                    const year = today.getFullYear();
                    dataPagamentoField._flatpickr.setDate(`${day}/${month}/${year}`);
                }
            } else {
                dataPagamentoContainer.style.display = 'none';
                dataPagamentoField._flatpickr.clear();
            }
        }

        // Executar na carga da página
        toggleDataPagamento();

        // Adicionar evento de change
        pagoCheckbox.addEventListener('change', toggleDataPagamento);
    });
</script>
{% endblock %}